apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
  namespace: default
data:
  init.sql: |
    -- ==========================================
    -- 1. 기존 스키마 정리 (의존성 역순 삭제)
    -- ==========================================
    DROP TABLE IF EXISTS comment CASCADE;
    DROP TABLE IF EXISTS report CASCADE;
    DROP TABLE IF EXISTS lab_assignment CASCADE;
    DROP TABLE IF EXISTS lab CASCADE;
    DROP TABLE IF EXISTS images CASCADE;
    DROP TABLE IF EXISTS users CASCADE;
    DROP TYPE IF EXISTS role_type;

    -- ==========================================
    -- 2. 타입 및 테이블 생성
    -- ==========================================
    
    -- Role Enum
    CREATE TYPE role_type AS ENUM ('HACKER', 'DEVELOPER');

    -- (1) Users 테이블
    CREATE TABLE users (
        id BIGSERIAL PRIMARY KEY,
        username VARCHAR(50) NOT NULL UNIQUE,
        password VARCHAR(255) NOT NULL,
        nickname VARCHAR(50),
        role role_type NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- (2) Images 테이블 (챌린지 템플릿 - 기본 정보)
    CREATE TABLE images (
        id BIGSERIAL PRIMARY KEY,
        title VARCHAR(255) NOT NULL,
        image_url VARCHAR(255) NOT NULL, -- 템플릿 소스코드 링크 등
        description TEXT,
        type VARCHAR(50) DEFAULT 'EXAMPLE',
        default_port INTEGER DEFAULT 80 NOT NULL -- 대표 포트 (FE 기준)
    );

    -- (3) Lab 테이블 (실제 배포된 3-Tier 환경)
    CREATE TABLE lab (
        id BIGSERIAL PRIMARY KEY,
        img_id BIGINT NOT NULL,
        developer_id BIGINT NOT NULL,
        title VARCHAR(100) NOT NULL,
        description TEXT,
        is_active BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        
        -- [3-Tier 이미지 정보]
        fe_image VARCHAR(255) NOT NULL, -- Frontend Image
        be_image VARCHAR(255) NOT NULL, -- Backend Image
        db_image VARCHAR(255), -- Database Image (or Nullable if SQLite)
        
        deploy_url VARCHAR(255), -- 배포 후 생성된 URL

        CONSTRAINT fk_lab_developer FOREIGN KEY (developer_id) REFERENCES users(id) ON DELETE CASCADE,
        CONSTRAINT fk_lab_image FOREIGN KEY (img_id) REFERENCES images(id) ON DELETE CASCADE
    );

    -- (4) Lab Assignment 테이블 (할당 관리)
    CREATE TABLE lab_assignment (
        id BIGSERIAL PRIMARY KEY,
        user_id BIGINT NOT NULL,
        lab_id BIGINT NOT NULL,
        assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        
        CONSTRAINT fk_assign_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        CONSTRAINT fk_assign_lab FOREIGN KEY (lab_id) REFERENCES lab(id) ON DELETE CASCADE,
        UNIQUE(user_id, lab_id)
    );

    -- (5) Report 테이블 (취약점 리포트)
    CREATE TABLE report (
        id BIGSERIAL PRIMARY KEY,
        author_id BIGINT NOT NULL,
        lab_id BIGINT NOT NULL,
        title VARCHAR(100) NOT NULL,
        content TEXT NOT NULL,
        severity VARCHAR(20) CHECK (severity IN ('HIGH', 'MEDIUM', 'LOW')), 
        
        status VARCHAR(20) DEFAULT 'PENDING' 
            CHECK (status IN ('PENDING', 'IN_PROGRESS', 'RESOLVED', 'REJECTED')), 
            
        developer_comment TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        
        CONSTRAINT fk_report_author FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE,
        CONSTRAINT fk_report_lab FOREIGN KEY (lab_id) REFERENCES lab(id) ON DELETE CASCADE
    );

    -- (6) Comment 테이블
    CREATE TABLE comment (
        id BIGSERIAL PRIMARY KEY,
        report_id BIGINT NOT NULL,
        author_id BIGINT NOT NULL,
        content TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

        CONSTRAINT fk_comment_report FOREIGN KEY (report_id) REFERENCES report(id) ON DELETE CASCADE,
        CONSTRAINT fk_comment_author FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
    );

    -- ==========================================
    -- 3. 초기 더미 데이터 (3-Tier 구조 반영)
    -- ==========================================
    
    -- 유저 생성
    INSERT INTO users (username, password, nickname, role) VALUES 
    ('dev_kim', '$2b$12$LWmlYY9Ihyx94FMAWdTI7OxAbzoOj168QVkLIgsFvxhkziLpK5MzS', 'KimDev', 'DEVELOPER'),
    ('hacker_lee', '$2b$12$2ymZJaFQAiCFEN3AEDdGi.Gc9tsXE6SK1fMYNKcR1soe8k/tYV4Dm', 'LeeHacker', 'HACKER');

    -- 챌린지 템플릿
    INSERT INTO images (title, image_url, description, type, default_port) VALUES 
    ('3-Tier Web Board', 'https://github.com/my-templates/board-v1', 'React + Spring + Postgres 구조의 게시판 템플릿', 'EXAMPLE', 80);

    -- 랩 생성 (3개의 이미지 주입)
    -- 여기서는 테스트를 위해 공개된 이미지들을 예시로 넣었습니다.
    INSERT INTO lab (title, description, developer_id, img_id, fe_image, be_image, db_image) VALUES 
    (
        'Vulnerable Board Service', 
        '게시판 SQL Injection 취약점 실습입니다. FE/BE/DB가 분리되어 있습니다.', 
        1, -- dev_kim
        1, -- 3-Tier Web Board 템플릿
        'nginx:latest',         -- Frontend (예시)
        'my-repo/backend:v1',   -- Backend (예시)
    );

    -- 랩 수강 신청
    INSERT INTO lab_assignment (user_id, lab_id) VALUES (2, 1);

    -- 리포트 제출
    INSERT INTO report (title, content, severity, status, author_id, lab_id) VALUES 
    ('게시판 검색창 SQL Injection', '검색어에 " OR 1=1 -- 입력 시 모든 글 노출됨', 'HIGH', 'PENDING', 2, 1);

    -- 댓글 작성
    INSERT INTO comment (report_id, author_id, content) VALUES
    (1, 1, '로그 확인해보니 쿼리 에러가 찍히네요. 수정하겠습니다.');