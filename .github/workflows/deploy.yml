name: Deploy DB to K3s

on:
  # 1. ì½”ë“œê°€ í‘¸ì‹œë˜ë©´ ìë™ ì‹¤í–‰
  push:
    branches: [ "main" ]
  
  # 2. GitHub ì›¹ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë²„íŠ¼ ì¶”ê°€
  workflow_dispatch:
    inputs:
      reset_db:
        description: 'ğŸ”¥ DBë¥¼ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë°ì´í„° ì‚­ì œë¨)'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: self-hosted # ìš°ë¦¬ ì§‘ ì„œë²„

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸŒŸ [í•µì‹¬] DB ì´ˆê¸°í™” ë¡œì§
      - name: Reset Database (If requested)
        run: |
          # ì¡°ê±´ 1: ìˆ˜ë™ ì‹¤í–‰ì‹œ ì²´í¬ë°•ìŠ¤ë¥¼ ì¼°ê±°ë‚˜
          # ì¡°ê±´ 2: ì»¤ë°‹ ë©”ì‹œì§€ì— [RESET-DB] ê°€ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜
          if [[ "${{ inputs.reset_db }}" == "true" || "${{ contains(github.event.head_commit.message, '[RESET-DB]') }}" == "true" ]]; then
            echo "ğŸš¨ DB ì´ˆê¸°í™” ìš”ì²­ ê°ì§€! ê¸°ì¡´ DBì™€ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤..."
            
            # DB ì„œë²„ ì¢…ë£Œ (ì—†ì–´ë„ ì—ëŸ¬ ì•ˆ ë‚˜ê²Œ --ignore-not-found ì˜µì…˜ ì¶”ê°€)
            kubectl delete deployment postgres-db --ignore-not-found=true
            
            # ğŸŒŸ ë°ì´í„° ì €ì¥ì†Œ(PVC) ì‚­ì œ -> ë°ì´í„° ì¦ë°œ & init.sql ì¬ì‹¤í–‰ ì¡°ê±´ ì¶©ì¡±
            kubectl delete pvc postgres-pvc --ignore-not-found=true
            
            echo "â³ ì‚­ì œê°€ ì™„ë£Œë  ë•Œê¹Œì§€ 10ì´ˆ ëŒ€ê¸°..."
            sleep 10
          else
            echo "âœ… DB ì´ˆê¸°í™” ìš”ì²­ ì—†ìŒ. ê¸°ì¡´ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."
          fi

      - name: Apply Kubernetes Manifests
        run: |
          echo "ğŸ“‚ Deploying Database..."
          
          # ConfigMap (init.sql) ë¨¼ì € ê°±ì‹ 
          kubectl apply -f init-configmap.yaml
          
          # PVC, Deployment, Service ë°°í¬
          kubectl apply -f pvc.yaml
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          
          echo "âœ… Deployment Applied!"
          kubectl rollout status deployment/postgres-db